#!/bin/sh
#-*-sh-*-

#
# Copyright © 2009 CNRS
# Copyright © 2009-2010 INRIA
# Copyright © 2009-2010 Université Bordeaux 1
# See COPYING in top-level directory.
#

abs_top_builddir="@abs_top_builddir@"
prefix="@prefix@"
exec_prefix="@exec_prefix@"
bindir="@bindir@"
# this will be changed into $bindir/lstopo during make install
lstopo="$abs_top_builddir/utils/lstopo"

name="$1"; shift
if [ -z "$name" ] ; then
  echo "$0 <name>"
  echo "  Saves the Linux topology files under ./<name>.tar.bz2"
  echo "  and the corresponding lstopo output under ./<name>.output"
  exit -1
fi

destdir=`mktemp -d`

error()
{
    echo $@ 2>&1
}

# Get all files from the given path (either a file or a directory)
# ignore errors since some files may be missing, and some may be
# Restricted to root (but we don't need them).
# Use cat so that we properly get proc/sys files even if their
# file length is wrong
savepath() {
  local dest="$1"
  local path="$2"
  find "$path" -type f 2>/dev/null | while read file ; do	\
    mkdir -p "$dest/"`dirname $file` ;		\
    cat "$file" > "$dest/$file" 2>/dev/null ;	\
  done
}

# Gather the following list of files and directories
cat << EOF | while read path ; do savepath "$destdir/$name" "$path" ; done
/sys/devices/system/cpu/
/sys/devices/system/node/
/sys/class/dmi/id/
/sys/kernel/mm/hugepages/
/proc/cpuinfo
/proc/meminfo
/proc/stat
/proc/device-tree/cpus
EOF

# Create the archive and keep the tree in /tmp for testing
( cd "$destdir/" && tar cfj "$name.tar.bz2" "$name" )
mv "$destdir/$name.tar.bz2" "./$name.tar.bz2"
echo "Hierarchy gathered in ./$name.tar.bz2 and kept in $destdir/$name/"

# Generate the output as well
if [ ! -x "$lstopo" ]
then
    error "Could not find lstopo executable in the install or build dir."
    exit 1
fi
# we need "Topology not from this system" in the output so as to make test-topology.sh happy
export HWLOC_THISSYSTEM=0
"$lstopo" - -v > "./$name.output"
echo "Expected topology output stored in ./$name.output"

exit 0
